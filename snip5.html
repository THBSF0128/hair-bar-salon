<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snipcart 3.0 Cart Persistence Example - Version Agnostic</title>
    <link rel="stylesheet" href="https://cdn.snipcart.com/themes/v3.3.1/default/snipcart.css" />
</head>
<body>
    <header>
        <h1>My Store</h1>
        <div class="snipcart-summary">
            <a href="#" class="snipcart-checkout">
                Cart (<span class="snipcart-items-count"></span>)
            </a>
        </div>
    </header>

    <main>
        <div class="product">
            <h2>Sample Product</h2>
            <button class="snipcart-add-item"
                data-item-id="sample-product"
                data-item-price="19.99"
                data-item-url="/"
                data-item-description="A sample product for testing"
                data-item-image="/path/to/image.jpg"
                data-item-name="Sample Product">
                Add to cart
            </button>
        </div>
    </main>

    <script>
        function initializeSnipcart() {
            console.log('Initializing Snipcart...');

            // Safely get cart items
            function getCartItems() {
                try {
                    if (typeof Snipcart !== 'undefined' && Snipcart.store) {
                        const state = Snipcart.store.getState();
                        return state?.cart?.items || [];
                    }
                    return [];
                } catch (error) {
                    console.error('Error getting cart items:', error);
                    return [];
                }
            }

            // Log cart items
            console.log('Initial cart items:', getCartItems());

            // Subscribe to cart changes
            if (typeof Snipcart !== 'undefined' && Snipcart.store) {
                Snipcart.store.subscribe(() => {
                    console.log('Cart updated, new items:', getCartItems());
                });
            }

            // Add event listeners for Snipcart events
            document.addEventListener('snipcart.ready', () => {
                console.log('Snipcart is ready');
                console.log('Cart items after Snipcart ready:', getCartItems());
            });

            document.addEventListener('snipcart.items.added', (event) => {
                console.log('Item added to cart:', event.detail);
            });

            // Attempt to force a cart update
            if (typeof Snipcart !== 'undefined' && Snipcart.api && Snipcart.api.cart) {
                Snipcart.api.cart.update({}).then(() => {
                    console.log('Cart forcefully updated');
                }).catch(error => {
                    console.error('Error updating cart:', error);
                });
            }
        }

        // Load Snipcart script dynamically
        var script = document.createElement('script');
        script.src = 'https://cdn.snipcart.com/themes/v3.3.1/default/snipcart.js';
        script.async = true;
        script.onload = initializeSnipcart;
        document.body.appendChild(script);
    </script>

    <div hidden id="snipcart" data-api-key="OTA5YmQ3YzUtODBhNy00NWIzLWFkZDktNGEwODc1NjkxNjhhNjM4NTYxNDI1MTQwMzQ3MTE0" data-config-add-product-behavior="none"></div>
</body>
</html>