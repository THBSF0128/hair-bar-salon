<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snipcart 3.0 Cart Persistence Example - Error Handling</title>
    <link rel="stylesheet" href="https://cdn.snipcart.com/themes/v3.3.1/default/snipcart.css" />
</head>
<body>
    <header>
        <h1>My Store</h1>
        <div class="snipcart-summary">
            <a href="#" class="snipcart-checkout">
                Cart (<span class="snipcart-items-count"></span>)
            </a>
        </div>
    </header>

    <main>
        <div class="product">
            <h2>Sample Product</h2>
            <button class="snipcart-add-item"
                data-item-id="sample-product"
                data-item-price="19.99"
                data-item-url="/"
                data-item-description="A sample product for testing"
                data-item-image="/path/to/image.jpg"
                data-item-name="Sample Product">
                Add to cart
            </button>
        </div>
    </main>

    <script async src="https://cdn.snipcart.com/themes/v3.3.1/default/snipcart.js"></script>
    <div hidden id="snipcart" data-api-key="OTA5YmQ3YzUtODBhNy00NWIzLWFkZDktNGEwODc1NjkxNjhhNjM4NTYxNDI1MTQwMzQ3MTE0" data-config-add-product-behavior="none"></div>

    <script>
        function safelyAccessCart() {
            if (typeof Snipcart !== 'undefined' && Snipcart.store) {
                const state = Snipcart.store.getState();
                if (state && state.cart && state.cart.items) {
                    console.log('Cart items:', state.cart.items);
                } else {
                    console.log('Cart or items not available in state');
                }
            } else {
                console.log('Snipcart not fully initialized yet');
            }
        }

        document.addEventListener('snipcart.ready', function() {
            console.log('Snipcart is ready');
            
            // Safely access cart data
            safelyAccessCart();

            // Subscribe to cart changes
            Snipcart.store.subscribe(() => {
                safelyAccessCart();
            });

            // Attempt to force a cart update
            if (typeof Snipcart.api !== 'undefined' && Snipcart.api.cart) {
                Snipcart.api.cart.update({}).then(() => {
                    console.log('Cart forcefully updated');
                    safelyAccessCart();
                }).catch(error => {
                    console.error('Error updating cart:', error);
                });
            } else {
                console.log('Snipcart API not available for force update');
            }
        });

        // Check Snipcart initialization status periodically
        let checkCount = 0;
        const maxChecks = 10;
        const checkInterval = setInterval(() => {
            if (typeof Snipcart !== 'undefined' && Snipcart.store) {
                console.log('Snipcart initialized');
                clearInterval(checkInterval);
                safelyAccessCart();
            } else {
                console.log('Waiting for Snipcart to initialize...');
                checkCount++;
                if (checkCount >= maxChecks) {
                    console.error('Snipcart failed to initialize after multiple attempts');
                    clearInterval(checkInterval);
                }
            }
        }, 1000);
    </script>
</body>
</html>